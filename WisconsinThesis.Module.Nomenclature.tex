% ===================================================================================== %
%                                  Nomen Module                                  %
% ===================================================================================== %


% =========================================================================== %
%                       Entry Independent Commands                            %
% =========================================================================== %
\DefineNewLength{\UWMad@Widest}         {0pt}        % Will have the value of the widest symbol for spacing
\DefineNewLength{\UWMad@WidestTest}     {0pt}        % Used to test for the widest symbol
\DefineNewLength{\NomenTitleSkip}       {0em}        % Used for title spacing
\DefineNewLength{\NomenPrintSkip}       {1em}        % Used for spacing after Nomen is printed
\DefineNewLength{\EntryMarginLeft}      {1em}
\DefineNewLength{\EntryMarginBottom}    {0.25em}

\DefineNewLocalCounter{UWMad@NomenNestLevel}   {0}
\DefineNewLocalCounter{UWMad@NomenSectionLevel}{0}

\GlobalNewIf{UWMad@MakeNomenclatureStarred}
\let\MakeNomenclatureStarred\UWMad@MakeNomenclatureStarredtrue
\let\MakeNomenclatureNotStarred\UWMad@MakeNomenclatureStarredfalse

\newcommand*{\UWMad@UpdateWidest}[1]{%
    \settowidth{\UWMad@WidestTest}{#1}%
    \ifdim\UWMad@Widest<\UWMad@WidestTest%
        \setlength{\UWMad@Widest}{\UWMad@WidestTest}%
    \fi%
}
%
%
\newcommand*{\TheNomenclatureName}{Nomenclature}
\newcommand{\NomenclatureName}[1]{%
    \renewcommand*{\TheNomenclatureName}{#1}%
}
%
\newcommand*{\TheNomenGroupName}{}
\newcommand{\NomenGroupName}[1]{%
    \renewcommand*{\TheNomenGroupName}{#1}%
}
%
%
\newcommand{\NomenclatureNameStyle}{
    \IfEmpty{\TheNomenGroupName}%
        {}%
        {\ifUWMad@MakeNomenclatureStarred%
            \csname\TheCurrentSectioningCommand\endcsname*%
                {\TheNomenGroupName}%
            \UWMad@FrontMatterRegister%
                [\TheCurrentSectioningCommand]%
                {\TheNomenGroupName}
         \else%
            \csname\TheCurrentSectioningCommand\endcsname{\TheNomenGroupName}%
         \fi}%
}
%
%
\newcommand*{\TheCurrentSectioningCommand}{}
\newcommand{\CurrentSectioningCommand}[1]{%
    \renewcommand*{\TheCurrentSectioningCommand}{#1}%
}


% =========================================================================== %
%                       Entry Dependent Commands                              %
% =========================================================================== %
\DefineNewLength{\SymbolWidth}          {0em}
\DefineNewLength{\DescriptionWidth}     {0em}
\DefineNewLength{\SymbolDescriptionPad} {0.75em}


\newcommand{\UpdateAddCommand}{}
%
\newcommand{\TheSymbolArrayName}{}
\newcommand{\TheDescriptionArrayName}{}
\newcommand{\SymbolArrayName}[1]     {\renewcommand{\TheSymbolArrayName}{#1}}
\newcommand{\DescriptionArrayName}[1]{\renewcommand{\TheDescriptionArrayName}{#1}}

\newcommand{\SetTheWidths}{%
    % Define Symbol minipage width
    \setlength  {\SymbolWidth}{\UWMad@Widest}%
    \addtolength{\SymbolWidth}{\SymbolDescriptionPad}%
    %
    % Define Description minipage width
    \setlength  {\DescriptionWidth}{\textwidth}%
    \addtolength{\DescriptionWidth}{-\SymbolWidth}%
    \addtolength{\DescriptionWidth}{-\EntryMarginLeft}%
    \setlength  {\DescriptionWidth}{0.99\DescriptionWidth}%
}

\newcommand{\NomenEntry}[2]{%
    \setstretch{1.1}%
    \hspace{\EntryMarginLeft}%
    \begin{minipage}[t]{\SymbolWidth}%
        #1%
    \end{minipage}%
    \begin{minipage}[t]{\DescriptionWidth}%
        #2%
    \end{minipage}%
    \vskip\EntryMarginBottom%
}

\newcommand{\NomenArrayIterator}{
    \ForEach[1]{\TheSymbolArrayName}%
        {\NomenEntry%
            {\ArrayGet%
                {\TheSymbolArrayName}%
                {ForLoopCounter}}%
            {\ArrayGet%
                {\TheDescriptionArrayName}%
                {ForLoopCounter}}}%
}

\newcommand{\NomenPrint}{%
    \NomenclatureNameStyle%         Print the name of the current group
    \ifnum\ArrayValueCount{\TheSymbolArrayName}>0%
        \SetTheWidths%              Set the widths of the minipages
        \NomenArrayIterator% Iterate over the entries
    \fi%
}


% =========================================================================== %
%                 Nomen Environment Initializer and Finalizer                 %
% =========================================================================== %
\newcommand{\NomenInitializer}{
    \SymbolArrayName
        {NomenSymbol}
    \DescriptionArrayName
        {NomenDescription}
    \ArrayMake
        {\TheSymbolArrayName}
    \ArrayMake
        {\TheDescriptionArrayName}
    \newcommand{\Add}[2]
        {\ArrayPush{\TheSymbolArrayName}{##1}
         \ArrayPush{\TheDescriptionArrayName}{##2}
         \UWMad@UpdateWidest{##1}}
    \let\item\Add
    \let\Item\Add
    \let\Entry\Add
}

\newcommand{\NomenFinalizer}[1]{%
    \NomenPrint%                     Print the current group's symbols and descriptions
    #1{\TheSymbolArrayName}%                Garbage Collection: \ArrayDelete or \ArrayReset
    #1{\TheDescriptionArrayName}%           Garbage Collection: \ArrayDelete or \ArrayReset
    \global\setlength{\UWMad@Widest}{0pt}%  Set the widest symbol to 0 for future lists
}


% =========================================================================== %
%          SubNomen Environment Initializer and Finalizer              %
% =========================================================================== %

% Nomenclature environment ----------------------------------------------------
\newenvironment{Nomenclature}[1][chapter]{%
    \CurrentSectioningCommand{#1}
    
    \SetCounter{UWMad@NomenSectionLevel}{\SectionToLevel{#1}}
    \SetCounter{UWMad@NomenNestLevel}{0}
    
    \NomenGroupName{\TheNomenclatureName}
    \NomenInitializer
}{%
    \NomenFinalizer{\ArrayDelete}%
}


\newenvironment{Group}[1]{% #1 = Group Name
    %
    \NomenFinalizer{\ArrayReset}%
    %
    \IfEmpty{#1}%
        {\NomenGroupName{}}%
        {\NomenGroupName{#1}%
         \StepCounter{UWMad@NomenSectionLevel}}%
    %
    \show\CurrentLevel
    %\CurrentSectioningCommand{\CurrentLevel}
}{%
    \NomenFinalizer{\ArrayReset}%
}%


